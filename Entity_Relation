
ydate=`date +%Y-%m-%d -d"1 day ago"`

bteq .LOGON TDDEV/EACSNDW_LOAD_01,Pa02word <<EOFF >> $EACS_LOG_DIR/JOB_INFO_`date +%Y-%m-%d`.log

CREATE MULTISET VOLATILE TABLE ECS_SRC_TARG_TBL ,NO FALLBACK ,
     NO BEFORE JOURNAL,
     NO AFTER JOURNAL,
     CHECKSUM = DEFAULT
     (
      JOB_NAME VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC NOT NULL,
      SCHEDULER_JOB_NAME VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC NOT NULL,
      APPLICATION_NAME VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC NOT NULL,
      SOURCE_SERVICE_NAME VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC ,
      SOURCE_DATABASE_NAME VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC ,
      SOURCE_TABLE_NAME VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC  NOT NULL,
      TARGET_SERVICE_NAME VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC ,
      TARGET_DATABASE_NAME VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC ,
      TARGET_TABLE_NAME VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC ,
      SOURCE_TECHNOLOGY_NAME VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC ,
      TARGET_TECHNOLOGY_NAME VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC ,
      TARGET_DATA_RETENTION_RULE VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC,
      COMMENTS VARCHAR(250) CHARACTER SET LATIN NOT CASESPECIFIC ,
      ACTIVE_FLAG CHAR(1) CHARACTER SET LATIN NOT CASESPECIFIC NOT NULL    
 )
ON COMMIT PRESERVE ROWS ;
.IMPORT VARTEXT ','  FILE=/nbcdevwc01/appl_data/CDW2/data/STG_SRC_TGT_DFP_PREMIUM.csv

.QUIET ON
.REPEAT *
.PACK 20000
USING 
(     JOB_NAME VARCHAR(400),
      SCHEDULER_JOB_NAME VARCHAR(400),
      APPLICATION_NAME VARCHAR(400) ,
      SOURCE_SERVICE_NAME VARCHAR(400),
      SOURCE_DATABASE_NAME VARCHAR(400),
      SOURCE_TABLE_NAME VARCHAR(400) ,
      TARGET_SERVICE_NAME VARCHAR(400),
      TARGET_DATABASE_NAME VARCHAR(400),
      TARGET_TABLE_NAME VARCHAR(400),
      SOURCE_TECHNOLOGY_NAME VARCHAR(400),
      TARGET_TECHNOLOGY_NAME VARCHAR(400),
      TARGET_DATA_RETENTION_RULE VARCHAR(400),
      COMMENTS VARCHAR(400),
      ACTIVE_FLAG VARCHAR(400)
      )        
INSERT INTO ECS_SRC_TARG_TBL
    ( 
	   JOB_NAME
      ,SCHEDULER_JOB_NAME
      ,APPLICATION_NAME 
      ,SOURCE_SERVICE_NAME
      ,SOURCE_DATABASE_NAME
      ,SOURCE_TABLE_NAME
      ,TARGET_SERVICE_NAME 
      ,TARGET_DATABASE_NAME 
      ,TARGET_TABLE_NAME
      ,SOURCE_TECHNOLOGY_NAME 
      ,TARGET_TECHNOLOGY_NAME 
      ,TARGET_DATA_RETENTION_RULE
      ,COMMENTS 
      ,ACTIVE_FLAG
)
VALUES ( 	  
	  :JOB_NAME,
      :SCHEDULER_JOB_NAME,
      :APPLICATION_NAME, 
      :SOURCE_SERVICE_NAME,
      :SOURCE_DATABASE_NAME,
      :SOURCE_TABLE_NAME,
      :TARGET_SERVICE_NAME, 
      :TARGET_DATABASE_NAME, 
      :TARGET_TABLE_NAME,
      :SOURCE_TECHNOLOGY_NAME, 
      :TARGET_TECHNOLOGY_NAME, 
      :TARGET_DATA_RETENTION_RULE,
      :COMMENTS, 
      :ACTIVE_FLAG
);

.IF ERRORCODE > 0 THEN .QUIT ERRORCODE 

INSERT INTO STG_SOURCE_TARGET_DTL
(	 	JOB_NAME
      ,SCHEDULER_JOB_NAME
      ,APPLICATION_NAME 
      ,SOURCE_SERVICE_NAME
      ,SOURCE_DATABASE_NAME
      ,SOURCE_TABLE_NAME
      ,TARGET_SERVICE_NAME 
      ,TARGET_DATABASE_NAME 
      ,TARGET_TABLE_NAME
      ,SOURCE_TECHNOLOGY_NAME 
      ,TARGET_TECHNOLOGY_NAME 
      ,TARGET_DATA_RETENTION_RULE
      ,COMMENTS 
      ,ACTIVE_FLAG
	  ,UPD_DTTM
	  ,UPD_USR_ID
	  ,CRT_DTTM
	  ,CRT_USR_ID
	)
SELECT  
	   JOB_NAME
      ,SCHEDULER_JOB_NAME
      ,APPLICATION_NAME 
      ,SOURCE_SERVICE_NAME
      ,SOURCE_DATABASE_NAME
      ,SOURCE_TABLE_NAME
      ,TARGET_SERVICE_NAME 
      ,TARGET_DATABASE_NAME 
      ,TARGET_TABLE_NAME
      ,SOURCE_TECHNOLOGY_NAME 
      ,TARGET_TECHNOLOGY_NAME 
      ,TARGET_DATA_RETENTION_RULE
      ,COMMENTS 
      ,ACTIVE_FLAG
	  ,CURRENT_TIMESTAMP(0)
	   ,'EACSNDW_LOAD_01'
	   ,CURRENT_TIMESTAMP(0)
	   ,'EACSNDW_LOAD_01'
	  FROM ECS_SRC_TARG_TBL;
	
.IF ERRORCODE > 0 THEN .QUIT ERRORCODE 
.LOGOFF
.QUIT
EOFF

ERRORCODE=${PIPESTATUS[0]}

if [ $ERRORCODE -ne 0 ]; then 
echo ""
echo "INFO: The BTEQ to insert data to the STG_SOURCE_TARGET_DTL stage table failed on `date` "
echo ""
fi
