if [ "$#" -ne 2 ]; then
    echo "You must enter exactly 2 command line arguments"
fi
echo $#

. /$1/appl_data/CDW2/properties/set_up_EACS1.sh

ydate=`date +%Y-%m-%d -d"1 day ago"`

bteq .LOGON TDDEV/EACSNDW_LOAD_01,Pa02word <<EOFF >> $EACS_LOG_DIR/USER_APPLICATION`date +%Y-%m-%d`.log

CREATE MULTISET VOLATILE TABLE ECS_USER_APPLICATION ,NO FALLBACK ,
     NO BEFORE JOURNAL,
     NO AFTER JOURNAL,
     CHECKSUM = DEFAULT
     (
	  SSO_ID VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC NOT NULL,
	  APPLICATION_ID VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC NOT NULL,
      ACTIVE_FLAG VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC NOT NULL	 
 )
ON COMMIT PRESERVE ROWS ;
.IMPORT VARTEXT ','  FILE=$2

.QUIET ON
.REPEAT *
.PACK 20000
USING 
(     
	  SSO_ID VARCHAR(400),
	  APPLICATION_ID VARCHAR(400),
      ACTIVE_FLAG VARCHAR(400)
      )        
INSERT INTO ECS_USER_APPLICATION
    ( 
	  SSO_ID,	
	  APPLICATION_ID,
      ACTIVE_FLAG   
)
VALUES ( 	  
	  :SSO_ID,
	  :APPLICATION_ID,
      :ACTIVE_FLAG  
);
.IF ERRORCODE > 0 THEN .QUIT ERRORCODE 

INSERT INTO USER_APPLICATION
(	  SSO_ID,	
	  APPLICATION_ID,     
      ACTIVE_FLAG ,
	  UPD_DTTM,
	  UPD_USR_ID,
	  CRT_DTTM,
	  CRT_USR_ID
	)
SELECT  
	  SSO_ID,	 
	  APPLICATION_ID,      
      ACTIVE_FLAG 
	  ,CURRENT_TIMESTAMP(0)
	  ,'EACSNDW_LOAD_01'
	  ,CURRENT_TIMESTAMP(0)
	  ,'EACSNDW_LOAD_01'
	  FROM ECS_USER_APPLICATION;
	
.IF ERRORCODE > 0 THEN .QUIT ERRORCODE 
.LOGOFF
.QUIT
EOFF

ERRORCODE=${PIPESTATUS[0]}

if [ $ERRORCODE -ne 0 ]; then 
echo ""
echo "INFO: The BTEQ to insert data to the USER_APPLICATION  table failed on `date` "
echo ""
fi
